
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="The documentation for the tatva software package">
      
      
      
      
        <link rel="prev" href="../nonlinear_hole_plate/">
      
      
        <link rel="next" href="../homogenization_periodic/">
      
      
        
      
      
      <link rel="icon" href="../../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.2">
    
    
      
        <title>Contact Mechanics - tatva</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"JetBrains Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/custom_css.css">
    
      <link rel="stylesheet" href="../../stylesheets/mkdocstrings.css">
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
    
      <link rel="stylesheet" href="../../stylesheets/carousel.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="amber">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#contact-mechanics" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="tatva" class="md-header__button md-logo" aria-label="tatva" data-md-component="logo">
      
  <img src="../../assets/favicon.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            tatva
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Contact Mechanics
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="amber"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="amber"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/smec-ethz/tatva" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    smec-ethz/tatva
  </div>
</a>
      </div>
    
  </nav>
  
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="tatva" class="md-nav__button md-logo" aria-label="tatva" data-md-component="logo">
      
  <img src="../../assets/favicon.png" alt="logo">

    </a>
    tatva
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/smec-ethz/tatva" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    smec-ethz/tatva
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Basics of tatva
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Basics of tatva
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../operator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Operator
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sparse/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Building Stiffness Matrix
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../compound/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Compound
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../lifter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lifter
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Examples
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Examples
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../linear_elasticity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Elasticity
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Multi-point Constraints
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Multi-point Constraints
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../nonlinear_hole_plate/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Rigid Body Constraints
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Contact Mechanics
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Contact Mechanics
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#meshing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Meshing
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#problem-setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Problem setup
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Problem setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#system-definition" class="md-nav__link">
    <span class="md-ellipsis">
      
        System definition
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#contact-energy-definition" class="md-nav__link">
    <span class="md-ellipsis">
      
        Contact energy definition
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elastic-energy-definition" class="md-nav__link">
    <span class="md-ellipsis">
      
        Elastic energy definition
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solve-system" class="md-nav__link">
    <span class="md-ellipsis">
      
        Solve system
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#results" class="md-nav__link">
    <span class="md-ellipsis">
      
        Results
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../homogenization_periodic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Periodic BCs (Lagrange Multipliers)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Mixed-Dimensional Coupling
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Mixed-Dimensional Coupling
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fracture_quasistatic_3d/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cohesive Fracture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../soft_hydrogel/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Embedded 1D Fibres
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6" >
        
          
          <label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Multiphysics Coupling
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Multiphysics Coupling
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../thermal_shock_fracture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Thermal-Shock Fracture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../advection_diffusion_surface/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Non-Variational Formulations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_8" >
        
          
          <label class="md-nav__link" for="__nav_3_8" id="__nav_3_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Data-Driven Modeling
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Data-Driven Modeling
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ncm_metamaterial/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Neural Constitutive Modeling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../neural_operator_method_3d/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Neural Operator Element Method
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Using External Solvers
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Using External Solvers
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../external_solvers/linear_elasticity_scipy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SciPy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    PETSc
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    PETSc
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../external_solvers/linear_elasticity_petsc4py/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sparse Solver
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../external_solvers/linear_elasticity_petsc4py_mf/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Matrix-Free Solver
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    API reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    API reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/tatva.operator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Operator
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/tatva.mesh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mesh
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/tatva.element/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Element
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/tatva.sparse/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sparse
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/tatva.compound/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Compound
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/tatva.lifter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lifter
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#meshing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Meshing
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#problem-setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Problem setup
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Problem setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#system-definition" class="md-nav__link">
    <span class="md-ellipsis">
      
        System definition
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#contact-energy-definition" class="md-nav__link">
    <span class="md-ellipsis">
      
        Contact energy definition
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elastic-energy-definition" class="md-nav__link">
    <span class="md-ellipsis">
      
        Elastic energy definition
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solve-system" class="md-nav__link">
    <span class="md-ellipsis">
      
        Solve system
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#results" class="md-nav__link">
    <span class="md-ellipsis">
      
        Results
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
                



  


  <nav class="md-path" aria-label="Navigation" >
    <ol class="md-path__list">
      
        
  
  
    <li class="md-path__item">
      <a href="../.." class="md-path__link">
        
  <span class="md-ellipsis">
    Getting Started
  </span>

      </a>
    </li>
  

      
      
        
  
  
    
    
      <li class="md-path__item">
        <a href="../linear_elasticity/" class="md-path__link">
          
  <span class="md-ellipsis">
    Examples
  </span>

        </a>
      </li>
    
  

      
    </ol>
  </nav>

              
              <article class="md-content__inner md-typeset">
                
                  



<p><a href="https://colab.research.google.com/github/smec-ethz/tatva-docs/blob/main/docs/examples/contact_3d.ipynb" target="_blank"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a></p>
<h1 id="contact-mechanics">Contact mechanics<a class="headerlink" href="#contact-mechanics" title="Permanent link">¤</a></h1>
<details class="example">
<summary>Colab Setup (Install Dependencies)</summary>
<div class="language-python highlight"><pre><span></span><code><span class="c1"># Only run this if we are in Google Colab</span>
<span class="k">if</span> <span class="s2">&quot;google.colab&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">get_ipython</span><span class="p">()):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Installing dependencies from pyproject.toml...&quot;</span><span class="p">)</span>
    <span class="c1"># This installs the repo itself (and its dependencies)</span>
    <span class="err">!</span><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">gmsh</span> 
    <span class="err">!</span><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">qq</span> <span class="n">xvfb</span> <span class="n">libgl1</span><span class="o">-</span><span class="n">mesa</span><span class="o">-</span><span class="n">glx</span>
    <span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">pyvista</span> <span class="o">-</span><span class="n">qq</span>
    <span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="s2">&quot;git+https://github.com/smec-ethz/tatva-docs.git&quot;</span>    

    <span class="kn">import</span><span class="w"> </span><span class="nn">pyvista</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pv</span>

    <span class="n">pv</span><span class="o">.</span><span class="n">global_theme</span><span class="o">.</span><span class="n">jupyter_backend</span> <span class="o">=</span> <span class="s2">&quot;static&quot;</span>
    <span class="n">pv</span><span class="o">.</span><span class="n">global_theme</span><span class="o">.</span><span class="n">notebook</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">pv</span><span class="o">.</span><span class="n">start_xvfb</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Installation complete!&quot;</span><span class="p">)</span>
</code></pre></div>
</details>
<p>In this notebook, we model the circular punch of a sphere on a deformable plane.</p>
<p>We impose the contact constraint via a penalty approach by extending the total energy functional with a contact contribution <span class="arithmatex">\(\Psi_c\)</span>, defined by the penalty density</p>
<div class="arithmatex">\[
\psi_c =\frac{1}{2} \kappa~ g(\boldsymbol{u}_1, \boldsymbol{u}_2)^2~,
\]</div>
<p>where <span class="arithmatex">\(g\)</span> represents the normal gap function and <span class="arithmatex">\(\kappa\)</span> denotes the penalty parameter. The resulting total energy functional reads</p>
<div class="arithmatex">\[\begin{equation}
\Psi(\boldsymbol{u}_1, \boldsymbol{u}_2) = \int_{\Omega_{\mathrm{sphere}}}\psi_\varepsilon(\boldsymbol{u}_1)~\mathrm{d\Omega} + \int_{\Omega_{\mathrm{cube}}}\psi_\varepsilon(\boldsymbol{u}_2)~\mathrm{d\Omega} +\int_{\mathrm{S}_c}\psi_c(\boldsymbol{u}_1, \boldsymbol{u}_2) ~\mathrm{dS} ~ .
\end{equation}\]</div>
<div class="language-python highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">gmsh</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax.numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">jnp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyvista</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pv</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jax</span><span class="w"> </span><span class="kn">import</span> <span class="n">Array</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jax_autovmap</span><span class="w"> </span><span class="kn">import</span> <span class="n">autovmap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tatva</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mesh</span><span class="p">,</span> <span class="n">Operator</span>

<span class="n">jax</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;jax_enable_x64&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">pv</span><span class="o">.</span><span class="n">global_theme</span><span class="o">.</span><span class="n">jupyter_backend</span> <span class="o">=</span> <span class="s2">&quot;static&quot;</span>
</code></pre></div>
<h2 id="meshing">Meshing<a class="headerlink" href="#meshing" title="Permanent link">¤</a></h2>
<p>We generate two separate meshes with <code>gmsh</code>; one for the cube, another one for the sphere.</p>
<details class="example">
<summary>Code for generating the mesh</summary>
<div class="language-python highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">gmsh</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>


<span class="k">def</span><span class="w"> </span><span class="nf">extract_mesh</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Mesh</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
    <span class="n">node_tags</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">getNodes</span><span class="p">()</span>
    <span class="n">nodes_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Gmsh tags are 1-based and potentially non-contiguous.</span>
    <span class="c1"># We map them to 0-based indices for JAX.</span>
    <span class="n">tag_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">node_tags</span><span class="p">)}</span>

    <span class="c1"># 5. Extract Tetrahedral Elements</span>
    <span class="c1"># Element Type 4 is 4-node Tetrahedron</span>
    <span class="c1"># getElementsByType returns: (element_tags, node_tags)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">elem_node_tags</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">getElementsByType</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">elem_node_tags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elem_node_tags</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">gmsh</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
        <span class="k">raise</span>

    <span class="c1"># Remap tags to 0-based indices</span>
    <span class="c1"># Vectorized map using a lookup array if tags are contiguous,</span>
    <span class="c1"># but loop is safer for general Gmsh output.</span>
    <span class="n">elements_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[[</span><span class="n">tag_map</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">]</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">elem_node_tags</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># --- physical surfaces: collect 2D triangle faces (Tri3 = type 2) per physical group ---</span>
    <span class="c1"># Returns: dict[name:str] -&gt; np.ndarray[int] of shape (ntri, 3) with 0-based node indices</span>
    <span class="n">physical_surfaces</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">pg_tag</span> <span class="ow">in</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getPhysicalGroups</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getPhysicalName</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">pg_tag</span><span class="p">)</span>

        <span class="c1"># Entities (surface tags) that belong to this physical group</span>
        <span class="n">entities</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getEntitiesForPhysicalGroup</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">pg_tag</span><span class="p">)</span>

        <span class="n">tris</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ent</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
            <span class="c1"># Get all mesh elements on this surface entity</span>
            <span class="n">types</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">node_tags_by_type</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">getElements</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">ent</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">etype</span><span class="p">,</span> <span class="n">ntags</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="n">node_tags_by_type</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">etype</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Tri3 only</span>
                    <span class="k">continue</span>
                <span class="n">tri_nodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ntags</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">tris</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tri_nodes</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tris</span><span class="p">:</span>
            <span class="n">physical_surfaces</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">tri_nodes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">tris</span><span class="p">)</span>
        <span class="n">tri_nodes_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">tag_map</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tri</span><span class="p">]</span> <span class="k">for</span> <span class="n">tri</span> <span class="ow">in</span> <span class="n">tri_nodes</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span>
        <span class="p">)</span>
        <span class="n">physical_surfaces</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">tri_nodes_0</span>

    <span class="k">return</span> <span class="n">Mesh</span><span class="p">(</span>
        <span class="n">coords</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nodes_arr</span><span class="p">),</span>
        <span class="n">elements</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elements_array</span><span class="p">),</span>
    <span class="p">),</span> <span class="n">physical_surfaces</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_mesh_cube</span><span class="p">(</span>
    <span class="n">h_min</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">h_max</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">h_corner</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Mesh</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
    <span class="n">ox</span><span class="p">,</span> <span class="n">oy</span><span class="p">,</span> <span class="n">oz</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">lx</span><span class="p">,</span> <span class="n">ly</span><span class="p">,</span> <span class="n">lz</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="n">gmsh</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;cube&quot;</span><span class="p">)</span>

    <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;General.Terminal&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Mesh.MshFileVersion&quot;</span><span class="p">,</span> <span class="mf">4.1</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Mesh.ElementOrder&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Mesh.Algorithm3D&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Mesh.CharacteristicLengthMin&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">h_min</span><span class="p">,</span> <span class="n">h_corner</span><span class="p">))</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Mesh.CharacteristicLengthMax&quot;</span><span class="p">,</span> <span class="n">h_max</span><span class="p">)</span>

    <span class="c1"># ---- 1) points (we keep the tags we care about) ----</span>
    <span class="n">p000</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="n">ox</span><span class="p">,</span> <span class="n">oy</span><span class="p">,</span> <span class="n">oz</span><span class="p">)</span>  <span class="c1"># corner of interest for refinement</span>
    <span class="n">p100</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="n">ox</span> <span class="o">+</span> <span class="n">lx</span><span class="p">,</span> <span class="n">oy</span><span class="p">,</span> <span class="n">oz</span><span class="p">)</span>
    <span class="n">p110</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="n">ox</span> <span class="o">+</span> <span class="n">lx</span><span class="p">,</span> <span class="n">oy</span> <span class="o">+</span> <span class="n">ly</span><span class="p">,</span> <span class="n">oz</span><span class="p">)</span>
    <span class="n">p010</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="n">ox</span><span class="p">,</span> <span class="n">oy</span> <span class="o">+</span> <span class="n">ly</span><span class="p">,</span> <span class="n">oz</span><span class="p">)</span>

    <span class="c1"># ---- 2) curves + base surface (z = oz) ----</span>
    <span class="n">l01</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">p000</span><span class="p">,</span> <span class="n">p100</span><span class="p">)</span>
    <span class="n">l12</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">p100</span><span class="p">,</span> <span class="n">p110</span><span class="p">)</span>
    <span class="n">l23</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">p110</span><span class="p">,</span> <span class="n">p010</span><span class="p">)</span>
    <span class="n">l30</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="n">p010</span><span class="p">,</span> <span class="n">p000</span><span class="p">)</span>

    <span class="n">cloop</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addCurveLoop</span><span class="p">([</span><span class="n">l01</span><span class="p">,</span> <span class="n">l12</span><span class="p">,</span> <span class="n">l23</span><span class="p">,</span> <span class="n">l30</span><span class="p">])</span>
    <span class="n">s_base</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addPlaneSurface</span><span class="p">([</span><span class="n">cloop</span><span class="p">])</span>

    <span class="c1"># ---- 3) volume via extrusion; capture returned entity tags (no searching) ----</span>
    <span class="c1"># extrude returns a list of (dim, tag). For a surface extrusion, you get:</span>
    <span class="c1">#   - one top surface (dim=2),</span>
    <span class="c1">#   - one volume (dim=3),</span>
    <span class="c1">#   - lateral surfaces (dim=2) ...</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">extrude</span><span class="p">([(</span><span class="mi">2</span><span class="p">,</span> <span class="n">s_base</span><span class="p">)],</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">lz</span><span class="p">)</span>

    <span class="n">vol_tag</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">tag</span> <span class="k">for</span> <span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span> <span class="ow">in</span> <span class="n">out</span> <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>

    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>

    <span class="c1"># ---- refinement field around p000 (no point lookup loop) ----</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Distance&quot;</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumbers</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="s2">&quot;PointsList&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">p000</span><span class="p">])</span>

    <span class="n">thr</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Threshold&quot;</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="n">thr</span><span class="p">,</span> <span class="s2">&quot;IField&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="n">thr</span><span class="p">,</span> <span class="s2">&quot;LcMin&quot;</span><span class="p">,</span> <span class="n">h_corner</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="n">thr</span><span class="p">,</span> <span class="s2">&quot;LcMax&quot;</span><span class="p">,</span> <span class="n">h_max</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="n">thr</span><span class="p">,</span> <span class="s2">&quot;DistMin&quot;</span><span class="p">,</span> <span class="n">h_corner</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="n">thr</span><span class="p">,</span> <span class="s2">&quot;DistMax&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setAsBackgroundMesh</span><span class="p">(</span><span class="n">thr</span><span class="p">)</span>

    <span class="c1"># ---- physical groups (using known tags) ----</span>
    <span class="n">vol_pg</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addPhysicalGroup</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">[</span><span class="n">vol_tag</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setPhysicalName</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">vol_pg</span><span class="p">,</span> <span class="s2">&quot;cube_volume&quot;</span><span class="p">)</span>

    <span class="n">top_pg</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addPhysicalGroup</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">s_base</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setPhysicalName</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">top_pg</span><span class="p">,</span> <span class="s2">&quot;cube_top&quot;</span><span class="p">)</span>

    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">mesh</span> <span class="o">=</span> <span class="n">extract_mesh</span><span class="p">()</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">mesh</span>


<span class="k">def</span><span class="w"> </span><span class="nf">mesh_bottom_eighth_sphere</span><span class="p">(</span>
    <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">h_min</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">h_max</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">h_corner</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Mesh</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
    <span class="n">r_ref</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="n">radius</span>

    <span class="n">gmsh</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;bottom_eighth_sphere&quot;</span><span class="p">)</span>

    <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;General.Terminal&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Mesh.MshFileVersion&quot;</span><span class="p">,</span> <span class="mf">4.1</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Mesh.ElementOrder&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Mesh.Algorithm3D&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Mesh.CharacteristicLengthMin&quot;</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">h_min</span><span class="p">,</span> <span class="n">h_corner</span><span class="p">))</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="s2">&quot;Mesh.CharacteristicLengthMax&quot;</span><span class="p">,</span> <span class="n">h_max</span><span class="p">)</span>

    <span class="n">sphere_tag</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addSphere</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
    <span class="n">box_tag</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addBox</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span>
        <span class="p">[(</span><span class="mi">3</span><span class="p">,</span> <span class="n">sphere_tag</span><span class="p">)],</span> <span class="p">[(</span><span class="mi">3</span><span class="p">,</span> <span class="n">box_tag</span><span class="p">)],</span> <span class="n">removeObject</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">removeTool</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>

    <span class="n">vol_tag</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># ---- refinement field at corner (0,0,0) ----</span>
    <span class="c1"># use Distance field with an explicit point; no need to find an existing CAD vertex</span>
    <span class="n">p_corner</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">occ</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>

    <span class="n">dist</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Distance&quot;</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumbers</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="s2">&quot;PointsList&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">p_corner</span><span class="p">])</span>

    <span class="n">thr</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Threshold&quot;</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="n">thr</span><span class="p">,</span> <span class="s2">&quot;IField&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="n">thr</span><span class="p">,</span> <span class="s2">&quot;LcMin&quot;</span><span class="p">,</span> <span class="n">h_corner</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="n">thr</span><span class="p">,</span> <span class="s2">&quot;LcMax&quot;</span><span class="p">,</span> <span class="n">h_max</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="n">thr</span><span class="p">,</span> <span class="s2">&quot;DistMin&quot;</span><span class="p">,</span> <span class="n">h_corner</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setNumber</span><span class="p">(</span><span class="n">thr</span><span class="p">,</span> <span class="s2">&quot;DistMax&quot;</span><span class="p">,</span> <span class="n">r_ref</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">setAsBackgroundMesh</span><span class="p">(</span><span class="n">thr</span><span class="p">)</span>

    <span class="c1"># --- identify spherical boundary surface by OCC type ---</span>
    <span class="n">boundary</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getBoundary</span><span class="p">([(</span><span class="mi">3</span><span class="p">,</span> <span class="n">vol_tag</span><span class="p">)],</span> <span class="n">oriented</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-6</span>  <span class="c1"># &lt;&lt; much looser than 1e-10</span>

    <span class="n">boundary</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getBoundary</span><span class="p">([(</span><span class="mi">3</span><span class="p">,</span> <span class="n">vol_tag</span><span class="p">)],</span> <span class="n">oriented</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">sphere_candidates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">boundary</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">zmax</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">getBoundingBox</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>

        <span class="n">is_x0</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xmin</span> <span class="o">-</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span>
        <span class="n">is_y0</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ymin</span> <span class="o">-</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span>
        <span class="n">is_zr</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">zmin</span> <span class="o">-</span> <span class="n">radius</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">zmax</span> <span class="o">-</span> <span class="n">radius</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">is_x0</span> <span class="ow">or</span> <span class="n">is_y0</span> <span class="ow">or</span> <span class="n">is_zr</span><span class="p">):</span>
            <span class="n">sphere_candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sphere_candidates</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Expected 1 spherical face, got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sphere_candidates</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">sphere_candidates</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">curved_surface</span> <span class="o">=</span> <span class="n">sphere_candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">vol_pg</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addPhysicalGroup</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">[</span><span class="n">vol_tag</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setPhysicalName</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">vol_pg</span><span class="p">,</span> <span class="s2">&quot;sphere_bottom_eighth&quot;</span><span class="p">)</span>

    <span class="n">surf_pg</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addPhysicalGroup</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">curved_surface</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">setPhysicalName</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">surf_pg</span><span class="p">,</span> <span class="s2">&quot;sphere_outer&quot;</span><span class="p">)</span>

    <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">mesh</span> <span class="o">=</span> <span class="n">extract_mesh</span><span class="p">()</span>
    <span class="n">gmsh</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">mesh</span>
</code></pre></div>
</details>
<details class="example">
<summary>Code for visualizing the mesh with PyVista</summary>
<div class="language-python highlight"><pre><span></span><code><span class="n">pv</span><span class="o">.</span><span class="n">set_jupyter_backend</span><span class="p">(</span><span class="s2">&quot;client&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_pyvista_grid</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">cell_type</span><span class="o">=</span><span class="s2">&quot;quad&quot;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">pv_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">mesh</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pv_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>

    <span class="n">cell_type_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;quad&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
        <span class="s2">&quot;triangle&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;tetra&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
        <span class="s2">&quot;hexahedron&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">pv_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
                <span class="n">fill_value</span><span class="o">=</span><span class="n">cell_type_dict</span><span class="p">[</span><span class="n">cell_type</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">mesh</span><span class="o">.</span><span class="n">elements</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">pv_cell_type_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;quad&quot;</span><span class="p">:</span> <span class="n">pv</span><span class="o">.</span><span class="n">CellType</span><span class="o">.</span><span class="n">QUAD</span><span class="p">,</span>
        <span class="s2">&quot;triangle&quot;</span><span class="p">:</span> <span class="n">pv</span><span class="o">.</span><span class="n">CellType</span><span class="o">.</span><span class="n">TRIANGLE</span><span class="p">,</span>
        <span class="s2">&quot;tetra&quot;</span><span class="p">:</span> <span class="n">pv</span><span class="o">.</span><span class="n">CellType</span><span class="o">.</span><span class="n">TETRA</span><span class="p">,</span>
        <span class="s2">&quot;hexahedron&quot;</span><span class="p">:</span> <span class="n">pv</span><span class="o">.</span><span class="n">CellType</span><span class="o">.</span><span class="n">HEXAHEDRON</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">cell_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
        <span class="n">fill_value</span><span class="o">=</span><span class="n">pv_cell_type_dict</span><span class="p">[</span><span class="n">cell_type</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span>
    <span class="p">)</span>

    <span class="n">grid</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="n">pv_cells</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">cell_types</span><span class="p">,</span> <span class="n">pv_points</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">grid</span>
</code></pre></div>
</details>
<div class="language-python highlight"><pre><span></span><code><span class="n">h_min</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">h_max</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="n">h_corner</span> <span class="o">=</span> <span class="mf">0.002</span>

<span class="n">mesh_cube</span><span class="p">,</span> <span class="n">pg_cube</span> <span class="o">=</span> <span class="n">get_mesh_cube</span><span class="p">(</span><span class="n">h_min</span><span class="p">,</span> <span class="n">h_max</span><span class="p">,</span> <span class="n">h_corner</span><span class="p">)</span>
</code></pre></div>
<details class="info">
<summary>Output</summary>
<div class="language-text highlight"><pre><span></span><code>Info    : Meshing 1D...
Info    : [  0%] Meshing curve 1 (Line)
Info    : [ 10%] Meshing curve 2 (Line)
Info    : [ 20%] Meshing curve 3 (Line)
Info    : [ 30%] Meshing curve 4 (Line)
Info    : [ 40%] Meshing curve 5 (Line)
Info    : [ 50%] Meshing curve 6 (Line)
Info    : [ 60%] Meshing curve 7 (Line)
Info    : [ 60%] Meshing curve 8 (Line)
Info    : [ 70%] Meshing curve 9 (Line)
Info    : [ 80%] Meshing curve 10 (Line)
Info    : [ 90%] Meshing curve 11 (Line)
Info    : [100%] Meshing curve 12 (Line)
Info    : Done meshing 1D (Wall 0.00662568s, CPU 0.00702s)
Info    : Meshing 2D...
Info    : [  0%] Meshing surface 1 (Plane, Frontal-Delaunay)
Info    : [ 20%] Meshing surface 2 (Plane, Frontal-Delaunay)
Info    : [ 40%] Meshing surface 3 (Plane, Frontal-Delaunay)
Info    : [ 60%] Meshing surface 4 (Plane, Frontal-Delaunay)
Info    : [ 70%] Meshing surface 5 (Plane, Frontal-Delaunay)
Info    : [ 90%] Meshing surface 6 (Plane, Frontal-Delaunay)
Info    : Done meshing 2D (Wall 0.0299664s, CPU 0.030777s)
Info    : Meshing 3D...
Info    : Meshing volume 1 (Frontal)
Info    : Region 1 Face 2, 1 intersect
Info    : Region 1 Face 3, 1 intersect
Info    : Region 1 Face 4, 1 intersect
Info    : Region 1 Face 5, 1 intersect
Info    : Region 1 Face 1, 1 intersect
Info    : Region 1 Face 6, 0 intersect
Info    : CalcLocalH: 872 Points 0 Elements 1740 Surface Elements 
Info    : Check subdomain 1 / 1 
Info    : 1740 open elements 
Info    : Meshing subdomain 1 of 1 
Info    : 1740 open elements 
Info    : Use internal rules 
Info    : 1740 open elements 
Info    : Delaunay meshing 
Info    : number of points: 872 
Info    : blockfill local h 
Info    : number of points: 1540 
Info    : Points: 1540 
Info    : Elements: 8619 
Info    : 0 open elements 
Info    : Num open: 0 
Info    : free: 0, fixed: 8619 
Info    : SwapImprove  
Info    : 0 swaps performed 
Info    : 0 open elements 
Info    : Num open: 0 
Info    : free: 0, fixed: 8619 
Info    : SwapImprove  
Info    : 0 swaps performed 
Info    : 0 degenerated elements removed 
Info    : Remove intersecting 
Info    : Remove outer 
Info    : tables filled 
Info    : outer removed 
Info    : 1740 open elements 
Info    : 1540 points, 6728 elements 
Info    : 0 open elements 
Info    : 0 open faces 
Info    : start tetmeshing 
Info    : Use internal rules 
Info    : 0 open elements 
Info    : Success ! 
Info    : 1540 points, 6728 elements 
Info    : Done meshing 3D (Wall 0.0881125s, CPU 0.08839s)
Info    : Optimizing mesh...
Info    : Optimizing volume 1
Info    : Optimization starts (volume = 1) with worst = 0.025172 / average = 0.681818:
Info    : 0.00 &lt; quality &lt; 0.10 :        21 elements
Info    : 0.10 &lt; quality &lt; 0.20 :        56 elements
Info    : 0.20 &lt; quality &lt; 0.30 :       173 elements
Info    : 0.30 &lt; quality &lt; 0.40 :       284 elements
Info    : 0.40 &lt; quality &lt; 0.50 :       301 elements
Info    : 0.50 &lt; quality &lt; 0.60 :       575 elements
Info    : 0.60 &lt; quality &lt; 0.70 :      1641 elements
Info    : 0.70 &lt; quality &lt; 0.80 :      2139 elements
Info    : 0.80 &lt; quality &lt; 0.90 :      1132 elements
Info    : 0.90 &lt; quality &lt; 1.00 :       403 elements
Info    : 191 edge swaps, 48 node relocations (volume = 1): worst = 0.233998 / average = 0.696372 (Wall 0.00368831s, CPU 0.003454s)
Info    : 209 edge swaps, 56 node relocations (volume = 1): worst = 0.239252 / average = 0.696901 (Wall 0.00458502s, CPU 0.004442s)
Info    : 210 edge swaps, 56 node relocations (volume = 1): worst = 0.239252 / average = 0.69702 (Wall 0.00514286s, CPU 0.004442s)
Info    : No ill-shaped tets in the mesh :-)
Info    : 0.00 &lt; quality &lt; 0.10 :         0 elements
Info    : 0.10 &lt; quality &lt; 0.20 :         0 elements
Info    : 0.20 &lt; quality &lt; 0.30 :        11 elements
Info    : 0.30 &lt; quality &lt; 0.40 :       301 elements
Info    : 0.40 &lt; quality &lt; 0.50 :       346 elements
Info    : 0.50 &lt; quality &lt; 0.60 :       650 elements
Info    : 0.60 &lt; quality &lt; 0.70 :      1593 elements
Info    : 0.70 &lt; quality &lt; 0.80 :      2106 elements
Info    : 0.80 &lt; quality &lt; 0.90 :      1160 elements
Info    : 0.90 &lt; quality &lt; 1.00 :       420 elements
Info    : Done optimizing mesh (Wall 0.00831119s, CPU 0.007544s)
Info    : 1540 nodes 8469 elements
</code></pre></div>
</details>
<div class="language-python highlight"><pre><span></span><code><span class="n">pl</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">Plotter</span><span class="p">(</span><span class="n">window_size</span><span class="o">=</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">600</span><span class="p">))</span>
<span class="n">pl</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">get_pyvista_grid</span><span class="p">(</span><span class="n">mesh_cube</span><span class="p">,</span> <span class="n">cell_type</span><span class="o">=</span><span class="s2">&quot;tetra&quot;</span><span class="p">),</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">azimuth</span> <span class="o">=</span> <span class="o">-</span><span class="mi">120</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p><img alt="img" src="../_data/34a3dbc819774f6a9dd12e406668b98a.png" /></p>
<div class="language-python highlight"><pre><span></span><code><span class="n">radius</span> <span class="o">=</span> <span class="mf">0.6</span>

<span class="n">mesh_sphere</span><span class="p">,</span> <span class="n">pg_sphere</span> <span class="o">=</span> <span class="n">mesh_bottom_eighth_sphere</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">h_min</span><span class="p">,</span> <span class="n">h_max</span><span class="p">,</span> <span class="n">h_corner</span><span class="p">)</span>
<span class="n">grid_sphere</span> <span class="o">=</span> <span class="n">get_pyvista_grid</span><span class="p">(</span><span class="n">mesh_sphere</span><span class="p">,</span> <span class="n">cell_type</span><span class="o">=</span><span class="s2">&quot;tetra&quot;</span><span class="p">)</span>
</code></pre></div>
<details class="info">
<summary>Output</summary>
<div class="language-text highlight"><pre><span></span><code>Info    : Cannot bind existing OpenCASCADE volume 1 to second tag 2                                                                              
Info    : Could not preserve tag of 3D object 2 (-&gt;1)
Info    : Meshing 1D...
Info    : [  0%] Meshing curve 1 (Circle)
Info    : [ 20%] Meshing curve 2 (Circle)
Info    : [ 50%] Meshing curve 4 (Circle)
Info    : [ 60%] Meshing curve 5 (Line)
Info    : [ 80%] Meshing curve 6 (Line)
Info    : [ 90%] Meshing curve 7 (Line)
Info    : Done meshing 1D (Wall 0.00492711s, CPU 0.004363s)
Info    : Meshing 2D...
Info    : [  0%] Meshing surface 1 (Sphere, Frontal-Delaunay)
Info    : [ 30%] Meshing surface 2 (Plane, Frontal-Delaunay)
Info    : [ 60%] Meshing surface 3 (Plane, Frontal-Delaunay)
Info    : [ 80%] Meshing surface 4 (Plane, Frontal-Delaunay)
Info    : Done meshing 2D (Wall 0.0239352s, CPU 0.024075s)
Info    : Meshing 3D...
Info    : Meshing volume 1 (Frontal)
Info    : Region 1 Face 1, 1 intersect
Info    : Region 1 Face 2, 1 intersect
Info    : Region 1 Face 3, 0 intersect
Info    : Region 1 Face 4, 0 intersect
Info    : CalcLocalH: 770 Points 0 Elements 1536 Surface Elements 
Info    : Check subdomain 1 / 1 
Info    : 1536 open elements 
Info    : Meshing subdomain 1 of 1 
Info    : 1536 open elements 
Info    : Use internal rules 
Info    : 1536 open elements 
Info    : Delaunay meshing 
Info    : number of points: 770 
Info    : blockfill local h 
Info    : number of points: 1485 
Info    : Points: 1485 
Info    : Elements: 8398 
Info    : 8 open elements 
Info    : Num open: 8 
Info    : free: 93, fixed: 8305 
Info    : SwapImprove  
Info    : 11 swaps performed 
Info    : 0 open elements 
Info    : Num open: 0 
Info    : free: 0, fixed: 8395 
Info    : SwapImprove  
Info    : 0 swaps performed 
Info    : 0 degenerated elements removed 
Info    : Remove intersecting 
Info    : Remove outer 
Info    : tables filled 
Info    : outer removed 
Info    : 1536 open elements 
Info    : 1485 points, 6768 elements 
Info    : 0 open elements 
Info    : 0 open faces 
Info    : start tetmeshing 
Info    : Use internal rules 
Info    : 0 open elements 
Info    : Success ! 
Info    : 1485 points, 6768 elements 
Info    : Done meshing 3D (Wall 0.0863274s, CPU 0.084559s)
Info    : Optimizing mesh...
Info    : Optimizing volume 1
Info    : Optimization starts (volume = 0.112136) with worst = 0.0388189 / average = 0.670886:
Info    : 0.00 &lt; quality &lt; 0.10 :         8 elements
Info    : 0.10 &lt; quality &lt; 0.20 :        92 elements
Info    : 0.20 &lt; quality &lt; 0.30 :       225 elements
Info    : 0.30 &lt; quality &lt; 0.40 :       384 elements
Info    : 0.40 &lt; quality &lt; 0.50 :       321 elements
Info    : 0.50 &lt; quality &lt; 0.60 :       643 elements
Info    : 0.60 &lt; quality &lt; 0.70 :      1447 elements
Info    : 0.70 &lt; quality &lt; 0.80 :      2136 elements
Info    : 0.80 &lt; quality &lt; 0.90 :      1166 elements
Info    : 0.90 &lt; quality &lt; 1.00 :       346 elements
Info    : 232 edge swaps, 76 node relocations (volume = 0.112136): worst = 0.129743 / average = 0.688803 (Wall 0.00520292s, CPU 0.004763s)
Info    : 258 edge swaps, 91 node relocations (volume = 0.112136): worst = 0.233733 / average = 0.690749 (Wall 0.00665104s, CPU 0.006296s)
Info    : 261 edge swaps, 95 node relocations (volume = 0.112136): worst = 0.233733 / average = 0.691017 (Wall 0.00753035s, CPU 0.007228s)
Info    : No ill-shaped tets in the mesh :-)
Info    : 0.00 &lt; quality &lt; 0.10 :         0 elements
Info    : 0.10 &lt; quality &lt; 0.20 :         0 elements
Info    : 0.20 &lt; quality &lt; 0.30 :        16 elements
Info    : 0.30 &lt; quality &lt; 0.40 :       371 elements
Info    : 0.40 &lt; quality &lt; 0.50 :       419 elements
Info    : 0.50 &lt; quality &lt; 0.60 :       715 elements
Info    : 0.60 &lt; quality &lt; 0.70 :      1422 elements
Info    : 0.70 &lt; quality &lt; 0.80 :      2112 elements
Info    : 0.80 &lt; quality &lt; 0.90 :      1163 elements
Info    : 0.90 &lt; quality &lt; 1.00 :       382 elements
Info    : Done optimizing mesh (Wall 0.0109751s, CPU 0.01085s)
Info    : 1486 nodes 8248 elements
</code></pre></div>
<div class="language-text highlight"><pre><span></span><code>Warning : Intersection - BOPAlgo_AlertUnableToOrientTheShape BOPAlgo_AlertUnableToOrientTheShape
</code></pre></div>
</details>
<div class="language-python highlight"><pre><span></span><code><span class="n">pl</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">Plotter</span><span class="p">(</span><span class="n">window_size</span><span class="o">=</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">600</span><span class="p">))</span>
<span class="n">pl</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid_sphere</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">pl</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">azimuth</span> <span class="o">=</span> <span class="o">-</span><span class="mi">120</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p><img alt="img" src="../_data/a069c5af303341578dc653609de4a6b4.png" /></p>
<h2 id="problem-setup">Problem setup<a class="headerlink" href="#problem-setup" title="Permanent link">¤</a></h2>
<h3 id="system-definition">System definition<a class="headerlink" href="#system-definition" title="Permanent link">¤</a></h3>
<p>Our problem includes two fields; <span class="arithmatex">\(u_\text{cube}\)</span> and <span class="arithmatex">\(u_\text{sphere}\)</span>. 
To handle them, we use both <a href="../../api/tatva.compound/#tatva.compound.Compound"><code>Compound</code></a> and <a href="../../api/tatva.lifter/#tatva.lifter.Lifter"><code>Lifter</code></a> utilities.
We first declare the <code>Solution</code> as a subclass of <code>Compound</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">tatva.compound</span><span class="w"> </span><span class="kn">import</span> <span class="n">Compound</span><span class="p">,</span> <span class="n">field</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Solution</span><span class="p">(</span><span class="n">Compound</span><span class="p">):</span>
    <span class="n">u_cube</span> <span class="o">=</span> <span class="n">field</span><span class="p">((</span><span class="n">mesh_cube</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">u_sphere</span> <span class="o">=</span> <span class="n">field</span><span class="p">((</span><span class="n">mesh_sphere</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>
</code></pre></div>
<p>Then we find boundary nodes to apply BCs. 
Exploiting the symmetry in the problem, we model only a quarter of the full geometric problem.
This means, we need to constrain these respective displacements.
Finally, we apply a top displacement <code>z_disp</code> on the top surface of the sphere octant.
We construct the <code>lifter</code> for our problem:</p>
<div class="language-python highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">tatva.lifter</span><span class="w"> </span><span class="kn">import</span> <span class="n">DirichletBC</span><span class="p">,</span> <span class="n">Lifter</span>

<span class="n">z_disp</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.001</span>

<span class="n">cube_sym_x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">mesh_cube</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">cube_sym_y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">mesh_cube</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">cube_bottom</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">mesh_cube</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sphere_sym_x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">mesh_sphere</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sphere_sym_y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">mesh_sphere</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sphere_top</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">jnp</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">mesh_sphere</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">mesh_sphere</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">lifter</span> <span class="o">=</span> <span class="n">Lifter</span><span class="p">(</span>
    <span class="n">Solution</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
    <span class="n">DirichletBC</span><span class="p">(</span><span class="n">Solution</span><span class="o">.</span><span class="n">u_cube</span><span class="p">[</span><span class="n">cube_sym_x</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
    <span class="n">DirichletBC</span><span class="p">(</span><span class="n">Solution</span><span class="o">.</span><span class="n">u_cube</span><span class="p">[</span><span class="n">cube_sym_y</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="n">DirichletBC</span><span class="p">(</span><span class="n">Solution</span><span class="o">.</span><span class="n">u_cube</span><span class="p">[</span><span class="n">cube_bottom</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span>
    <span class="n">DirichletBC</span><span class="p">(</span><span class="n">Solution</span><span class="o">.</span><span class="n">u_sphere</span><span class="p">[</span><span class="n">sphere_sym_x</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
    <span class="n">DirichletBC</span><span class="p">(</span><span class="n">Solution</span><span class="o">.</span><span class="n">u_sphere</span><span class="p">[</span><span class="n">sphere_sym_y</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="n">DirichletBC</span><span class="p">(</span><span class="n">Solution</span><span class="o">.</span><span class="n">u_sphere</span><span class="p">[</span><span class="n">sphere_top</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">z_disp</span><span class="p">),</span>
<span class="p">)</span>
</code></pre></div>
<p>Finally, we now define the two <a href="../../api/tatva.operator/#tatva.operator.Operator"><code>Operators</code></a> from the meshes and the element type. 
In this example, we use 4-node Tetrahedral elements <a href="../../api/tatva.element/#tatva.element.Tetrahedron4"><code>Tetrahedron4</code></a>.</p>
<div class="language-python highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">tatva.element</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tetrahedron4</span>

<span class="n">el</span> <span class="o">=</span> <span class="n">Tetrahedron4</span><span class="p">()</span>
<span class="n">op_cube</span> <span class="o">=</span> <span class="n">Operator</span><span class="p">(</span><span class="n">mesh_cube</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>
<span class="n">op_sphere</span> <span class="o">=</span> <span class="n">Operator</span><span class="p">(</span><span class="n">mesh_sphere</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>
</code></pre></div>
<h3 id="contact-energy-definition">Contact energy definition<a class="headerlink" href="#contact-energy-definition" title="Permanent link">¤</a></h3>
<p>Contact potential energy contribution based on gap function between two deformable meshes.
The contact contribution to the total energy is evaluated using a <strong>two-pass node-to-surface contact detection scheme</strong>.
The total contact energy is defined as the arithmetic mean of the two surface contributions.
This symmetric formulation avoids master–slave bias and improves robustness, particularly for comparable mesh resolutions and material stiffnesses.</p>
<p><strong>First pass (sphere → cube):</strong></p>
<ul>
<li>Each surface node of the sphere is orthogonally projected onto the cube surface.</li>
<li>The normal gap is evaluated at the projection point.</li>
<li>The corresponding penalty density is integrated over the sphere surface.</li>
</ul>
<p><strong>Second pass (cube → sphere):</strong></p>
<ul>
<li>Each surface node of the cube is orthogonally projected onto the sphere surface.</li>
<li>The normal gap is computed analogously.</li>
<li>The penalty contribution is integrated over the cube surface.</li>
</ul>
<p>To integrate across the 3d manifold, we need to define a <code>Tri3Manifold</code> element type, and we define two surface operators:</p>
<div class="language-python highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">tatva.element</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tri3</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Tri3Manifold</span><span class="p">(</span><span class="n">Tri3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A 3-node linear triangular element on a 2D manifold embedded in 3D space.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_jacobian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xi</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span> <span class="n">nodal_coords</span><span class="p">:</span> <span class="n">Array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="n">Array</span><span class="p">]:</span>
        <span class="n">dNdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_function_derivative</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
        <span class="n">J</span> <span class="o">=</span> <span class="n">dNdr</span> <span class="o">@</span> <span class="n">nodal_coords</span>  <span class="c1"># shape (2, 2) or (2, 3)</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">J</span> <span class="o">@</span> <span class="n">J</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># shape (2, 2)</span>
        <span class="n">detJ</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">G</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">J</span><span class="p">,</span> <span class="n">detJ</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">gradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xi</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span> <span class="n">nodal_values</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span> <span class="n">nodal_coords</span><span class="p">:</span> <span class="n">Array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
        <span class="n">dNdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_function_derivative</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>  <span class="c1"># shape (2, 3)</span>
        <span class="n">J</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_jacobian</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">nodal_coords</span><span class="p">)</span>  <span class="c1"># shape (2, 3)</span>

        <span class="n">G_inv</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">J</span> <span class="o">@</span> <span class="n">J</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>  <span class="c1"># shape (2, 2)</span>
        <span class="n">J_plus</span> <span class="o">=</span> <span class="n">J</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">G_inv</span>  <span class="c1"># shape (3, 2)</span>

        <span class="n">dudxi</span> <span class="o">=</span> <span class="n">dNdr</span> <span class="o">@</span> <span class="n">nodal_values</span>  <span class="c1"># shape (2, n_values)</span>
        <span class="k">return</span> <span class="n">J_plus</span> <span class="o">@</span> <span class="n">dudxi</span>  <span class="c1"># shape (3, n_values)</span>


<span class="n">surf_op_cube</span> <span class="o">=</span> <span class="n">Operator</span><span class="p">(</span>
    <span class="n">mesh_cube</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">elements</span><span class="o">=</span><span class="n">pg_cube</span><span class="p">[</span><span class="s2">&quot;cube_top&quot;</span><span class="p">]),</span> <span class="n">Tri3Manifold</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">surf_op_sphere</span> <span class="o">=</span> <span class="n">Operator</span><span class="p">(</span>
    <span class="n">mesh_sphere</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">elements</span><span class="o">=</span><span class="n">pg_sphere</span><span class="p">[</span><span class="s2">&quot;sphere_outer&quot;</span><span class="p">]),</span> <span class="n">Tri3Manifold</span><span class="p">()</span>
<span class="p">)</span>
</code></pre></div>
<details class="example">
<summary>Code for computing the gap function</summary>
<div class="language-python highlight"><pre><span></span><code><span class="nd">@autovmap</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">el_coords</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">reference_point</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_get_gap_and_inside_mask</span><span class="p">(</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span> <span class="n">el_coords</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span> <span class="n">reference_point</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-12</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="n">Array</span><span class="p">]:</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">el_coords</span>
    <span class="n">e0</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span>
    <span class="n">e1</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x0</span>

    <span class="n">n0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">e0</span><span class="p">,</span> <span class="n">e1</span><span class="p">)</span>
    <span class="n">nn</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">vdot</span><span class="p">(</span><span class="n">n0</span><span class="p">,</span> <span class="n">n0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_degenerate</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_regular</span><span class="p">():</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n0</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nn</span><span class="p">)</span>
        <span class="c1"># orient normal (only affects gap sign)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">x0</span> <span class="o">-</span> <span class="n">reference_point</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="n">n</span><span class="p">)</span>

        <span class="n">gap</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">xproj</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">gap</span> <span class="o">*</span> <span class="n">n</span>

        <span class="c1"># inside test using edge half-spaces</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">,</span> <span class="n">xproj</span> <span class="o">-</span> <span class="n">x0</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">,</span> <span class="n">xproj</span> <span class="o">-</span> <span class="n">x1</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">x0</span> <span class="o">-</span> <span class="n">x2</span><span class="p">,</span> <span class="n">xproj</span> <span class="o">-</span> <span class="n">x2</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span>

        <span class="n">inside</span> <span class="o">=</span> <span class="p">(</span><span class="n">c0</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">eps</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">c1</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">eps</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">c2</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">eps</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inside</span><span class="p">,</span> <span class="n">gap</span>

    <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">nn</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">_degenerate</span><span class="p">,</span> <span class="n">_regular</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_gap</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span> <span class="n">el_coords</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span> <span class="n">reference_point</span><span class="p">:</span> <span class="n">Array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
    <span class="n">mask</span><span class="p">,</span> <span class="n">gap</span> <span class="o">=</span> <span class="n">_get_gap_and_inside_mask</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">el_coords</span><span class="p">,</span> <span class="n">reference_point</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">gap</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>
</code></pre></div>
</details>
<div class="language-python highlight"><pre><span></span><code><span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">contact_energy</span><span class="p">(</span><span class="n">x_cube</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span> <span class="n">x_sphere</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">kappa</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Contact energy with cube as master surface.</span>

<span class="sd">    Args:</span>
<span class="sd">        x_cube: (n_cube_nodes, 3) array of cube node coordinates</span>
<span class="sd">        x_sphere: (n_sphere_nodes, 3) array of sphere node coordinates</span>
<span class="sd">        kappa: penalty stiffness parameter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># for each sphere surface quad point, compute gap to cube surface</span>
    <span class="n">gap</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_gap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x_cube</span><span class="p">[</span><span class="n">pg_cube</span><span class="p">[</span><span class="s2">&quot;cube_top&quot;</span><span class="p">]],</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">])),</span>
        <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)(</span><span class="n">surf_op_sphere</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">x_sphere</span><span class="p">))</span>

    <span class="c1"># for each cube surface quad point, compute gap to sphere surface</span>
    <span class="n">gap_inv</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_gap</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span>
            <span class="n">x_sphere</span><span class="p">[</span><span class="n">pg_sphere</span><span class="p">[</span><span class="s2">&quot;sphere_outer&quot;</span><span class="p">]],</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">radius</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">]),</span>
        <span class="p">),</span>
        <span class="n">in_axes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)(</span><span class="n">surf_op_cube</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">x_cube</span><span class="p">))</span>

    <span class="c1"># only negative gaps contribute to energy; add singleton dim for integration</span>
    <span class="n">gap</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">gap</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">gap_inv</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">gap_inv</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>

    <span class="c1"># return arithmetic mean of sphere and cube contributions to energy</span>
    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span>
        <span class="mf">0.5</span> <span class="o">*</span> <span class="n">kappa</span> <span class="o">*</span> <span class="n">surf_op_sphere</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">gap</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">kappa</span> <span class="o">*</span> <span class="n">surf_op_cube</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">gap_inv</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>
<h3 id="elastic-energy-definition">Elastic energy definition<a class="headerlink" href="#elastic-energy-definition" title="Permanent link">¤</a></h3>
<p>Here, we employ a linear elastic material model. We define the material point functions for strain and stress:</p>
<div class="language-python highlight"><pre><span></span><code><span class="nd">@autovmap</span><span class="p">(</span><span class="n">grad_u</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_strain</span><span class="p">(</span><span class="n">grad_u</span><span class="p">:</span> <span class="n">Array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">grad_u</span> <span class="o">+</span> <span class="n">grad_u</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>


<span class="nd">@autovmap</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lmbda</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_stress</span><span class="p">(</span><span class="n">eps</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span> <span class="n">mu</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">lmbda</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">eps</span> <span class="o">+</span> <span class="n">lmbda</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">eps</span><span class="p">)</span> <span class="o">*</span> <span class="n">I</span>


<span class="nd">@autovmap</span><span class="p">(</span><span class="n">grad_u</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">lmbda</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">strain_energy</span><span class="p">(</span><span class="n">grad_u</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span> <span class="n">mu</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">lmbda</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="n">compute_strain</span><span class="p">(</span><span class="n">grad_u</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">compute_stress</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">lmbda</span><span class="p">)</span>
    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij,ij-&gt;&quot;</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span>
</code></pre></div>
<p>Let's quickly add a material utility.</p>
<div class="language-python highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">NamedTuple</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Material</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Material properties for the elasticity operator.&quot;&quot;&quot;</span>

    <span class="n">mu</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># Diffusion coefficient</span>
    <span class="n">lmbda</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># Diffusion coefficient</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_youngs_poisson</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">E</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">nu</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Material&quot;</span><span class="p">:</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">E</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">nu</span><span class="p">)</span>
        <span class="n">lmbda</span> <span class="o">=</span> <span class="n">E</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nu</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nu</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">lmbda</span><span class="o">=</span><span class="n">lmbda</span><span class="p">)</span>


<span class="n">mat_cube</span> <span class="o">=</span> <span class="n">Material</span><span class="o">.</span><span class="n">from_youngs_poisson</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
<span class="n">mat_sphere</span> <span class="o">=</span> <span class="n">Material</span><span class="o">.</span><span class="n">from_youngs_poisson</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
</code></pre></div>
<p>Finally, we define the <strong>total energy functional</strong>:</p>
<div class="language-python highlight"><pre><span></span><code><span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">static_argnames</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;kappa&quot;</span><span class="p">,))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">total_energy_full</span><span class="p">(</span><span class="n">u_full</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span> <span class="n">kappa</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
    <span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span> <span class="o">=</span> <span class="n">Solution</span><span class="p">(</span><span class="n">u_full</span><span class="p">)</span>
    <span class="n">e1</span> <span class="o">=</span> <span class="n">strain_energy</span><span class="p">(</span><span class="n">op_cube</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">u1</span><span class="p">),</span> <span class="n">mat_cube</span><span class="o">.</span><span class="n">mu</span><span class="p">,</span> <span class="n">mat_cube</span><span class="o">.</span><span class="n">lmbda</span><span class="p">)</span>
    <span class="n">e2</span> <span class="o">=</span> <span class="n">strain_energy</span><span class="p">(</span><span class="n">op_sphere</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">u2</span><span class="p">),</span> <span class="n">mat_sphere</span><span class="o">.</span><span class="n">mu</span><span class="p">,</span> <span class="n">mat_sphere</span><span class="o">.</span><span class="n">lmbda</span><span class="p">)</span>

    <span class="c1"># extract surface displacements, compute position, and contact energy</span>
    <span class="n">xcube_surf</span> <span class="o">=</span> <span class="n">mesh_cube</span><span class="o">.</span><span class="n">coords</span> <span class="o">+</span> <span class="n">u1</span>  <span class="c1"># current position of all cube nodes</span>
    <span class="n">xsphere_surf</span> <span class="o">=</span> <span class="n">mesh_sphere</span><span class="o">.</span><span class="n">coords</span> <span class="o">+</span> <span class="n">u2</span>  <span class="c1"># current position of all sphere nodes</span>
    <span class="n">e_contact</span> <span class="o">=</span> <span class="n">contact_energy</span><span class="p">(</span><span class="n">xcube_surf</span><span class="p">,</span> <span class="n">xsphere_surf</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="n">kappa</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">op_cube</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span> <span class="o">+</span> <span class="n">op_sphere</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">e2</span><span class="p">)</span> <span class="o">+</span> <span class="n">e_contact</span>


<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">static_argnames</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;kappa&quot;</span><span class="p">,))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">total_energy</span><span class="p">(</span><span class="n">u_free</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span> <span class="n">kappa</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the total energy of the system.&quot;&quot;&quot;</span>
    <span class="n">u_full</span> <span class="o">=</span> <span class="n">lifter</span><span class="o">.</span><span class="n">lift_from_zeros</span><span class="p">(</span><span class="n">u_free</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">total_energy_full</span><span class="p">(</span><span class="n">u_full</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="n">kappa</span><span class="p">)</span>


<span class="n">residual_fn</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="n">total_energy</span><span class="p">)</span>
</code></pre></div>
<h3 id="solve-system">Solve system<a class="headerlink" href="#solve-system" title="Permanent link">¤</a></h3>
<details class="example">
<summary>Newton-Krylov solver</summary>
<div class="language-python highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>


<span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnames</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gradient&quot;</span><span class="p">,</span> <span class="s2">&quot;compute_tangent&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">newton_krylov_solver</span><span class="p">(</span>
    <span class="n">u</span><span class="p">,</span>
    <span class="n">gradient</span><span class="p">,</span>
    <span class="n">compute_tangent</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">residual</span> <span class="o">=</span> <span class="n">gradient</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="n">norm_res</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">residual</span><span class="p">)</span>

    <span class="n">init_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">norm_res</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cond_fun</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">iiter</span><span class="p">,</span> <span class="n">norm_res</span> <span class="o">=</span> <span class="n">state</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">norm_res</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">,</span> <span class="n">iiter</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">body_fun</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
        <span class="n">jax</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
            <span class="s2">&quot;Iteration </span><span class="si">{iter}</span><span class="s2">, Residual norm: </span><span class="si">{res:.2e}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">iter</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">res</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">iiter</span><span class="p">,</span> <span class="n">norm_res</span> <span class="o">=</span> <span class="n">state</span>
        <span class="n">residual</span> <span class="o">=</span> <span class="n">gradient</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">compute_tangent</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">du</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cg</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="o">-</span><span class="n">residual</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">jax</span><span class="o">.</span><span class="n">block_until_ready</span><span class="p">(</span><span class="n">du</span><span class="p">)</span>
        <span class="n">jax</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;  CG solve time: </span><span class="si">{time:.2f}</span><span class="s2"> s&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>

        <span class="n">u</span> <span class="o">=</span> <span class="n">u</span> <span class="o">+</span> <span class="n">du</span>

        <span class="n">residual</span> <span class="o">=</span> <span class="n">gradient</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="n">norm_res</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">residual</span><span class="p">)</span>
        <span class="n">jax</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;  Residual norm: </span><span class="si">{res:.2e}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="n">norm_res</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">iiter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">norm_res</span><span class="p">)</span>

    <span class="n">final_u</span><span class="p">,</span> <span class="n">final_iiter</span><span class="p">,</span> <span class="n">final_norm</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">while_loop</span><span class="p">(</span><span class="n">cond_fun</span><span class="p">,</span> <span class="n">body_fun</span><span class="p">,</span> <span class="n">init_val</span><span class="p">)</span>
    <span class="n">jax</span><span class="o">.</span><span class="n">debug</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;  Residual: </span><span class="si">{res:.2e}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="n">final_norm</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">final_u</span><span class="p">,</span> <span class="n">final_norm</span>
</code></pre></div>
</details>
<div class="language-python highlight"><pre><span></span><code><span class="n">fn</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">residual_fn</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="mf">2e3</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_jvp</span><span class="p">(</span><span class="n">loc</span><span class="p">:</span> <span class="n">Array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Array</span><span class="p">],</span> <span class="n">Array</span><span class="p">]:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_jvp_fn</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">jvp</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="p">(</span><span class="n">loc</span><span class="p">,),</span> <span class="p">(</span><span class="n">v</span><span class="p">,))[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">_jvp_fn</span>


<span class="n">z0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">lifter</span><span class="o">.</span><span class="n">size_reduced</span><span class="p">)</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">Solution</span><span class="o">.</span><span class="n">u_sphere</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">z_disp</span><span class="p">)</span>
<span class="n">z_sol</span><span class="p">,</span> <span class="n">norm_res</span> <span class="o">=</span> <span class="n">newton_krylov_solver</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="n">z0</span><span class="p">,</span> <span class="n">gradient</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span> <span class="n">compute_tangent</span><span class="o">=</span><span class="n">_jvp</span><span class="p">)</span>
</code></pre></div>
<details class="info">
<summary>Output</summary>
<div class="language-text highlight"><pre><span></span><code>CG solve time: 0.03 s
Iteration 0, Residual norm: 4.11e-03
  Residual norm: 1.54e-05
  CG solve time: 0.03 s
Iteration 1, Residual norm: 1.54e-05
  Residual norm: 1.21e-05
  CG solve time: 0.03 s
Iteration 2, Residual norm: 1.21e-05
  Residual norm: 4.33e-07
  CG solve time: 0.03 s
Iteration 3, Residual norm: 4.33e-07
  Residual norm: 9.20e-08
  CG solve time: 0.03 s
Iteration 4, Residual norm: 9.20e-08
  Residual norm: 5.61e-09
  Residual: 5.61e-09
</code></pre></div>
</details>
<div class="language-python highlight"><pre><span></span><code><span class="c1"># Use Solution to unpack the full solution vector into displacements for cube and sphere</span>
<span class="n">u1</span><span class="p">,</span> <span class="n">u2</span> <span class="o">=</span> <span class="n">Solution</span><span class="p">(</span><span class="n">lifter</span><span class="o">.</span><span class="n">lift_from_zeros</span><span class="p">(</span><span class="n">z_sol</span><span class="p">))</span>
</code></pre></div>
<h2 id="results">Results<a class="headerlink" href="#results" title="Permanent link">¤</a></h2>
<details class="example">
<summary>Function to visualize the results with PyVista</summary>
<div class="language-python highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_contact_result</span><span class="p">(</span>
    <span class="n">mesh_sphere</span><span class="p">,</span>
    <span class="n">mesh_cube</span><span class="p">,</span>
    <span class="n">u_sphere</span><span class="p">,</span>
    <span class="n">u_cube</span><span class="p">,</span>
    <span class="n">stress_sphere</span><span class="p">,</span>
    <span class="n">stress_cube</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;managua&quot;</span><span class="p">,</span>
    <span class="n">clim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;static&quot;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pyvista</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pv</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">von_mises_stress</span><span class="p">(</span><span class="n">stress</span><span class="p">):</span>
        <span class="n">sxx</span> <span class="o">=</span> <span class="n">stress</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">syy</span> <span class="o">=</span> <span class="n">stress</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">szz</span> <span class="o">=</span> <span class="n">stress</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">sxy</span> <span class="o">=</span> <span class="n">stress</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">syz</span> <span class="o">=</span> <span class="n">stress</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">szx</span> <span class="o">=</span> <span class="n">stress</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="mf">0.5</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">sxx</span> <span class="o">-</span> <span class="n">syy</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">syy</span> <span class="o">-</span> <span class="n">szz</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">szz</span> <span class="o">-</span> <span class="n">sxx</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="n">sxy</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">syz</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">szx</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># --- build grids ---</span>
    <span class="n">grid_s</span> <span class="o">=</span> <span class="n">get_pyvista_grid</span><span class="p">(</span><span class="n">mesh_sphere</span><span class="p">,</span> <span class="n">cell_type</span><span class="o">=</span><span class="s2">&quot;tetra&quot;</span><span class="p">)</span>
    <span class="n">grid_s</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">u_sphere</span><span class="p">)</span>
    <span class="n">grid_s</span><span class="o">.</span><span class="n">cell_data</span><span class="p">[</span><span class="s2">&quot;sig_vm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">von_mises_stress</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">stress_sphere</span><span class="p">))</span>
    <span class="n">grid_s</span><span class="o">.</span><span class="n">cell_data</span><span class="p">[</span><span class="s2">&quot;sig_zz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">stress_sphere</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">grid_s</span><span class="o">.</span><span class="n">cell_data</span><span class="p">[</span><span class="s2">&quot;sig_zx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">stress_sphere</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">grid_s</span><span class="o">.</span><span class="n">warp_by_vector</span><span class="p">(</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="n">factor</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">grid_c</span> <span class="o">=</span> <span class="n">get_pyvista_grid</span><span class="p">(</span><span class="n">mesh_cube</span><span class="p">,</span> <span class="n">cell_type</span><span class="o">=</span><span class="s2">&quot;tetra&quot;</span><span class="p">)</span>
    <span class="n">grid_c</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">u_cube</span><span class="p">)</span>
    <span class="n">grid_c</span><span class="o">.</span><span class="n">cell_data</span><span class="p">[</span><span class="s2">&quot;sig_vm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">von_mises_stress</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">stress_cube</span><span class="p">))</span>
    <span class="n">grid_c</span><span class="o">.</span><span class="n">cell_data</span><span class="p">[</span><span class="s2">&quot;sig_zz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">stress_cube</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">grid_c</span><span class="o">.</span><span class="n">cell_data</span><span class="p">[</span><span class="s2">&quot;sig_zx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">stress_cube</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">grid_c</span><span class="o">.</span><span class="n">warp_by_vector</span><span class="p">(</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="n">factor</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">pv</span><span class="o">.</span><span class="n">set_jupyter_backend</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span>
    <span class="n">pl</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">Plotter</span><span class="p">(</span><span class="n">window_size</span><span class="o">=</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">1200</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="p">(</span><span class="n">grid_s</span><span class="p">,</span> <span class="n">grid_c</span><span class="p">):</span>
        <span class="n">g</span><span class="o">.</span><span class="n">translate</span><span class="p">((</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># --- lighting ---</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">remove_all_lights</span><span class="p">()</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">add_light</span><span class="p">(</span>
        <span class="n">pv</span><span class="o">.</span><span class="n">Light</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">focal_point</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">intensity</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">add_light</span><span class="p">(</span>
        <span class="n">pv</span><span class="o">.</span><span class="n">Light</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mf">15.0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">focal_point</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">intensity</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># --- sphere ---</span>
    <span class="n">surf_s</span> <span class="o">=</span> <span class="n">grid_s</span><span class="o">.</span><span class="n">cell_data_to_point_data</span><span class="p">()</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span>
        <span class="n">surf_s</span><span class="p">,</span>
        <span class="n">scalars</span><span class="o">=</span><span class="s2">&quot;sig_vm&quot;</span><span class="p">,</span>
        <span class="n">show_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">edge_opacity</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
        <span class="n">clim</span><span class="o">=</span><span class="n">clim</span><span class="p">,</span>
        <span class="n">opacity</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">iso_s</span> <span class="o">=</span> <span class="n">surf_s</span><span class="o">.</span><span class="n">extract_surface</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;dataset_surface&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span>
        <span class="n">isosurfaces</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">scalars</span><span class="o">=</span><span class="s2">&quot;sig_vm&quot;</span>
    <span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">iso_s</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">clim</span><span class="o">=</span><span class="n">clim</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

    <span class="c1"># --- cube ---</span>
    <span class="n">surf_c</span> <span class="o">=</span> <span class="n">grid_c</span><span class="o">.</span><span class="n">cell_data_to_point_data</span><span class="p">()</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span>
        <span class="n">surf_c</span><span class="p">,</span>
        <span class="n">scalars</span><span class="o">=</span><span class="s2">&quot;sig_vm&quot;</span><span class="p">,</span>
        <span class="n">show_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">edge_opacity</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
        <span class="n">clim</span><span class="o">=</span><span class="n">clim</span><span class="p">,</span>
        <span class="n">opacity</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">iso_c</span> <span class="o">=</span> <span class="n">surf_c</span><span class="o">.</span><span class="n">extract_surface</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;dataset_surface&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span>
        <span class="n">isosurfaces</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">scalars</span><span class="o">=</span><span class="s2">&quot;sig_vm&quot;</span>
    <span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">iso_c</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">clim</span><span class="o">=</span><span class="n">clim</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

    <span class="n">pl</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">scalar_bar</span><span class="o">.</span><span class="n">SetVisibility</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">pl</span><span class="o">.</span><span class="n">view_isometric</span><span class="p">()</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">azimuth</span> <span class="o">-=</span> <span class="mi">160</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">elevation</span> <span class="o">-=</span> <span class="mi">20</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.4</span><span class="p">,</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">zoom</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
</details>
<div class="language-python highlight"><pre><span></span><code><span class="n">eps_box</span> <span class="o">=</span> <span class="n">compute_strain</span><span class="p">(</span><span class="n">op_cube</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">u1</span><span class="p">))</span>
<span class="n">stress_box</span> <span class="o">=</span> <span class="n">compute_stress</span><span class="p">(</span><span class="n">eps_box</span><span class="p">,</span> <span class="n">mat_cube</span><span class="o">.</span><span class="n">mu</span><span class="p">,</span> <span class="n">mat_cube</span><span class="o">.</span><span class="n">lmbda</span><span class="p">)</span>
<span class="n">eps_sphere</span> <span class="o">=</span> <span class="n">compute_strain</span><span class="p">(</span><span class="n">op_sphere</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">u2</span><span class="p">))</span>
<span class="n">stress_sphere</span> <span class="o">=</span> <span class="n">compute_stress</span><span class="p">(</span><span class="n">eps_sphere</span><span class="p">,</span> <span class="n">mat_sphere</span><span class="o">.</span><span class="n">mu</span><span class="p">,</span> <span class="n">mat_sphere</span><span class="o">.</span><span class="n">lmbda</span><span class="p">)</span>


<span class="n">plot_contact_result</span><span class="p">(</span><span class="n">mesh_sphere</span><span class="p">,</span> <span class="n">mesh_cube</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="n">u1</span><span class="p">,</span> <span class="n">stress_sphere</span><span class="p">,</span> <span class="n">stress_box</span><span class="p">)</span>
</code></pre></div>
<p><img alt="img" src="../_data/6a92da03f65e462f8b38cea812dff7f7.png" /></p>
<details class="example">
<summary>Code for computing the analytical solution for Hertzian contact</summary>
<div class="language-python highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">force_analytical</span><span class="p">(</span><span class="n">E</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">R</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Analytical contact force for a sphere indenting a half-space.</span>

<span class="sd">    Args:</span>
<span class="sd">        E: Young&#39;s modulus of the half-space.</span>
<span class="sd">        R: Radius of the sphere.</span>
<span class="sd">        d: Indentation depth (positive).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">E</span> <span class="o">*</span> <span class="n">R</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">d</span><span class="o">**</span><span class="mf">1.5</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_a</span><span class="p">(</span><span class="n">R</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Hertzian contact radius from indentation depth.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">R</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">p_max</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">F</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">a</span><span class="o">**</span><span class="mi">2</span>


<span class="k">def</span><span class="w"> </span><span class="nf">sig_z</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">p_max</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">p_max</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span> <span class="o">/</span> <span class="n">a</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_analytical_stress</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="n">E</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="mf">0.3</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">get_a</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
    <span class="n">pmax</span> <span class="o">=</span> <span class="n">p_max</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">sig_z</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">pmax</span><span class="p">)</span>
</code></pre></div>
</details>
<details class="example">
<summary>Create plot for <span class="arithmatex">\(\sigma_{zz}\)</span> along the centerline and compare to analytical solution</summary>
<div class="language-python highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">NearestNDInterpolator</span><span class="p">,</span> <span class="n">LinearNDInterpolator</span>

<span class="n">nodal_coords</span> <span class="o">=</span> <span class="n">mesh_cube</span><span class="o">.</span><span class="n">coords</span>
<span class="n">quad_coords</span> <span class="o">=</span> <span class="n">op_cube</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">mesh_cube</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

<span class="n">grid</span> <span class="o">=</span> <span class="n">get_pyvista_grid</span><span class="p">(</span><span class="n">mesh_cube</span><span class="p">,</span> <span class="n">cell_type</span><span class="o">=</span><span class="s2">&quot;tetra&quot;</span><span class="p">)</span>
<span class="n">grid</span><span class="o">.</span><span class="n">cell_data</span><span class="p">[</span><span class="s2">&quot;sig_zz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stress_box</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">nodal_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">cell_data_to_point_data</span><span class="p">()</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s2">&quot;sig_zz&quot;</span><span class="p">])</span>
<span class="n">interp</span> <span class="o">=</span> <span class="n">LinearNDInterpolator</span><span class="p">(</span><span class="n">nodal_coords</span><span class="p">,</span> <span class="n">nodal_sig</span><span class="p">)</span>

<span class="c1"># z-extent of the cube</span>
<span class="n">zmin</span> <span class="o">=</span> <span class="n">mesh_cube</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="n">zmax</span> <span class="o">=</span> <span class="n">mesh_cube</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="c1"># Compute analytical solution for Hertzian contact</span>
<span class="n">z_disp_abs</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z_disp</span><span class="p">)</span>
<span class="n">radius</span> <span class="o">=</span> <span class="mf">0.6</span>
<span class="n">E_star</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.3</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">F</span> <span class="o">=</span> <span class="n">force_analytical</span><span class="p">(</span><span class="n">E_star</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">z_disp_abs</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">get_a</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">z_disp_abs</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">3.4</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">))</span>  <span class="c1"># single-column width</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_sig_zz</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
    <span class="n">zi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">zmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">zmax</span> <span class="o">-</span> <span class="n">zmin</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">zmax</span> <span class="o">+</span> <span class="n">z_disp_abs</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">p_max</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">get_analytical_stress</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">z_disp_abs</span><span class="p">)(</span><span class="n">zi</span><span class="p">)</span> <span class="o">/</span> <span class="n">p0</span><span class="p">,</span>
        <span class="n">zi</span><span class="p">,</span>
        <span class="s2">&quot;:&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Hertz solution&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">interp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">zi</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">zi</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">zi</span><span class="p">])</span> <span class="o">/</span> <span class="n">p0</span><span class="p">,</span>
        <span class="n">zi</span><span class="p">,</span>
        <span class="s2">&quot;-&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;tatva&quot;</span><span class="p">,</span>
        <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\sigma_</span><span class="si">{zz}</span><span class="s2"> / p_0$&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$z$&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>


<span class="n">plot_sig_zz</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</code></pre></div>
</details>
<p><img alt="img" src="../_data/ec85c466acc84279b419e5984046dfca.png" /></p>
<details class="example">
<summary>Create plot for traction distribution <span class="arithmatex">\(p(r)\)</span> and compare to analytical solution</summary>
<div class="language-python highlight"><pre><span></span><code><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">3.4</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">))</span>  <span class="c1"># single-column width</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_traction</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.4</span> <span class="o">*</span> <span class="n">a</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="mf">0.00</span>

    <span class="n">p0</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">F</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">a</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">p_of_r</span><span class="p">(</span><span class="n">r</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">a</span><span class="p">,</span> <span class="n">p0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">a</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xi</span> <span class="o">/</span> <span class="n">a</span><span class="p">,</span> <span class="n">p_of_r</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span> <span class="o">/</span> <span class="n">p0</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Hertz solution&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">xi</span> <span class="o">/</span> <span class="n">a</span><span class="p">,</span>
        <span class="o">-</span><span class="n">interp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">offset</span><span class="p">),</span> <span class="n">xi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="mi">0</span><span class="p">)])</span> <span class="o">/</span> <span class="n">p0</span><span class="p">,</span>
        <span class="s2">&quot;-&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;tatva&quot;</span><span class="p">,</span>
        <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower left&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$r / a$&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$p(r) / p_0$&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>


<span class="n">plot_traction</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</code></pre></div>
</details>
<div class="language-text highlight"><pre><span></span><code>/tmp/ipykernel_122596/4210642787.py:13: RuntimeWarning: invalid value encountered in sqrt
  return np.where(r &lt; a, p0 * np.sqrt(1 - (r / a) ** 2), 0)
</code></pre></div>
<p><img alt="img" src="../_data/ac1696c14129420bb216314c7f20bbbb.png" /></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2026 ETH Zurich (SMEC)
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.sections", "header-autohide", "announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.tooltips", "navigation.instant.preview", "navigation.path", "navigation.sections", "navigation.tabs.sticky", "search.highlight", "search.suggest", "content.footnote.tooltips"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://unpkg.com/vtk.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
      
        <script src="../../javascripts/carousel.js"></script>
      
    
  </body>
</html>