
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="The documentation for the tatva software package">
      
      
      
      
        <link rel="prev" href="../operator/">
      
      
        <link rel="next" href="../compound/">
      
      
        
      
      
      <link rel="icon" href="../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.2">
    
    
      
        <title>Building Stiffness Matrix - tatva</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"JetBrains Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../stylesheets/custom_css.css">
    
      <link rel="stylesheet" href="../stylesheets/mkdocstrings.css">
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
    
      <link rel="stylesheet" href="../stylesheets/carousel.css">
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="amber">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#building-stiffness-matrix" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="tatva" class="md-header__button md-logo" aria-label="tatva" data-md-component="logo">
      
  <img src="../assets/favicon.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            tatva
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Building Stiffness Matrix
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="amber"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="amber"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/smec-ethz/tatva" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    smec-ethz/tatva
  </div>
</a>
      </div>
    
  </nav>
  
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="tatva" class="md-nav__button md-logo" aria-label="tatva" data-md-component="logo">
      
  <img src="../assets/favicon.png" alt="logo">

    </a>
    tatva
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/smec-ethz/tatva" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    smec-ethz/tatva
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Basics of tatva
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Basics of tatva
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../operator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Operator
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Building Stiffness Matrix
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Building Stiffness Matrix
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#problem" class="md-nav__link">
    <span class="md-ellipsis">
      
        Problem
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solution" class="md-nav__link">
    <span class="md-ellipsis">
      
        Solution
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matrix-free-operator" class="md-nav__link">
    <span class="md-ellipsis">
      
        Matrix-free Operator
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sparse-differentiation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sparse Differentiation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Sparse Differentiation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sparsity-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sparsity Pattern
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#graph-coloring" class="md-nav__link">
    <span class="md-ellipsis">
      
        Graph Coloring
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sparse-differentiation_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sparse Differentiation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#computing-k-at-fixed-additional-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Computing K at fixed additional parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../compound/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Compound
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lifter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lifter
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Examples
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Examples
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/linear_elasticity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Elasticity
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Multi-point Constraints
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Multi-point Constraints
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/nonlinear_hole_plate/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Rigid Body Constraints
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/contact_3d/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contact Mechanics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/homogenization_periodic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Periodic BCs (Lagrange Multipliers)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Mixed-Dimensional Coupling
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Mixed-Dimensional Coupling
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/fracture_quasistatic_3d/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cohesive Fracture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/soft_hydrogel/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Embedded 1D Fibres
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6" >
        
          
          <label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Multiphysics Coupling
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Multiphysics Coupling
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/thermal_shock_fracture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Thermal-Shock Fracture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/advection_diffusion_surface/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Non-Variational Formulations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_8" >
        
          
          <label class="md-nav__link" for="__nav_3_8" id="__nav_3_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Data-Driven Modeling
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Data-Driven Modeling
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/ncm_metamaterial/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Neural Constitutive Modeling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/neural_operator_method_3d/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Neural Operator Element Method
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Using External Solvers
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Using External Solvers
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../external_solvers/linear_elasticity_scipy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SciPy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    PETSc
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    PETSc
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../external_solvers/linear_elasticity_petsc4py/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sparse Solver
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../external_solvers/linear_elasticity_petsc4py_mf/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Matrix-Free Solver
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    API reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    API reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/tatva.operator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Operator
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/tatva.mesh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mesh
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/tatva.element/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Element
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/tatva.sparse/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sparse
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/tatva.compound/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Compound
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/tatva.lifter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lifter
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#problem" class="md-nav__link">
    <span class="md-ellipsis">
      
        Problem
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solution" class="md-nav__link">
    <span class="md-ellipsis">
      
        Solution
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matrix-free-operator" class="md-nav__link">
    <span class="md-ellipsis">
      
        Matrix-free Operator
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sparse-differentiation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sparse Differentiation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Sparse Differentiation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sparsity-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sparsity Pattern
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#graph-coloring" class="md-nav__link">
    <span class="md-ellipsis">
      
        Graph Coloring
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sparse-differentiation_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sparse Differentiation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#computing-k-at-fixed-additional-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Computing K at fixed additional parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
                



  


  <nav class="md-path" aria-label="Navigation" >
    <ol class="md-path__list">
      
        
  
  
    <li class="md-path__item">
      <a href=".." class="md-path__link">
        
  <span class="md-ellipsis">
    Getting Started
  </span>

      </a>
    </li>
  

      
      
        
  
  
    
    
      <li class="md-path__item">
        <a href="../operator/" class="md-path__link">
          
  <span class="md-ellipsis">
    Basics of tatva
  </span>

        </a>
      </li>
    
  

      
    </ol>
  </nav>

              
              <article class="md-content__inner md-typeset">
                
                  



<p><a href="https://colab.research.google.com/github/smec-ethz/tatva-docs/blob/main/docs/sparse.ipynb" target="_blank"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a></p>
<h1 id="building-stiffness-matrix">Building Stiffness Matrix<a class="headerlink" href="#building-stiffness-matrix" title="Permanent link">¤</a></h1>
<details class="example">
<summary>Colab Setup (Install Dependencies)</summary>
<div class="language-python highlight"><pre><span></span><code><span class="c1"># Only run this if we are in Google Colab</span>
<span class="k">if</span> <span class="s1">&#39;google.colab&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">get_ipython</span><span class="p">()):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Installing dependencies from pyproject.toml...&quot;</span><span class="p">)</span>
    <span class="c1"># This installs the repo itself (and its dependencies)</span>
    <span class="err">!</span><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">gmsh</span> 
    <span class="err">!</span><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">qq</span> <span class="n">xvfb</span> <span class="n">libgl1</span><span class="o">-</span><span class="n">mesa</span><span class="o">-</span><span class="n">glx</span>
    <span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">pyvista</span> <span class="o">-</span><span class="n">qq</span>
    <span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="s2">&quot;git+https://github.com/smec-ethz/tatva-docs.git&quot;</span>    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Installation complete!&quot;</span><span class="p">)</span>
</code></pre></div>
</details>
<h2 id="problem">Problem<a class="headerlink" href="#problem" title="Permanent link">¤</a></h2>
<p>In finite element analysis, the tangent stiffness matrix (Hessian) <span class="arithmatex">\(\mathbf{K}\)</span> is typically <strong>sparse</strong>. A node only interacts with its immediate neighbors, meaning most entries in <span class="arithmatex">\(\mathbf{K}\)</span> are zero. However, standard automatic differentiation (AD) in JAX (<code>jax.jacfwd</code> or <code>jax.jacrev</code>) is unaware of this sparsity. It attempts to recover the full dense matrix by evaluating the Jacobian-Vector Product (JVP) once for every degree of freedom.</p>
<p>For a mesh with <span class="arithmatex">\(N\)</span> degrees of freedom:</p>
<ul>
<li><strong>Naive AD Cost:</strong> <span class="arithmatex">\(N \times t_{\text{residual}}\)</span> (Prohibitive for large <span class="arithmatex">\(N\)</span>)</li>
<li><strong>Memory:</strong> <span class="arithmatex">\(O(N^2)\)</span> (Explodes quickly)</li>
</ul>
<p>We need a way to compute <strong>only the non-zero entries</strong> of <span class="arithmatex">\(\mathbf{K}\)</span> efficiently, ideally in constant time with respect to the mesh size.</p>
<h2 id="solution">Solution<a class="headerlink" href="#solution" title="Permanent link">¤</a></h2>
<p><code>tatva</code> provides 2 ways to build a computationally efficient stiffness matrix using the energy functional.</p>
<ul>
<li><strong>Matrix-free operator</strong> using Jacobian-vector product.</li>
<li><strong>Sparse stiffness matrix</strong> using sparse differentiation.</li>
</ul>
<p>Below we demonstrate the two approaches, we use a pseudo energy functional that is defined for a given mesh.</p>
<div class="language-python highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">jax</span>
<span class="n">jax</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;jax_enable_x64&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>  <span class="c1"># use double-precision</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">jax.numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">jnp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tatva</span><span class="w"> </span><span class="kn">import</span> <span class="n">sparse</span><span class="p">,</span> <span class="n">Mesh</span>

<span class="n">mesh</span> <span class="o">=</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">unit_square</span><span class="p">(</span><span class="n">n_x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;triangle&quot;</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">n_dofs_per_node</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">n_dofs</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_dofs_per_node</span>


<span class="k">def</span><span class="w"> </span><span class="nf">energy_fn</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">delta</span><span class="p">):</span>
    <span class="c1"># Placeholder for the actual energy function</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">delta</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>

<span class="n">delta_current</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Example parameter</span>
</code></pre></div>
<h2 id="matrix-free-operator">Matrix-free Operator<a class="headerlink" href="#matrix-free-operator" title="Permanent link">¤</a></h2>
<p>Since we have the energy functional, we can compute the Jacobian-vector product (JVP) <span class="arithmatex">\(\mathbf{K}\mathbf{v}\)</span> directly without ever forming <span class="arithmatex">\(\mathbf{K}\)</span>. We can use <a href="https://docs.jax.dev/en/latest/_autosummary/jax.jvp.html"><code>jax.jvp</code></a> to compute the Jacobian-vector product.</p>
<div class="language-python highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">jacobian_vector_product</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">delta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes (Hessian of Energy at u) * v. It is equivalent to: jvp( jacrev(energy)(u), v ).</span>
<span class="sd">    Args:</span>
<span class="sd">        u: Current solution (shape: [n_dofs])</span>
<span class="sd">        v: Vector to multiply with the Hessian (shape: [n_dofs])</span>
<span class="sd">        delta: Additional parameter for the energy function</span>
<span class="sd">    Returns:</span>
<span class="sd">        The product of the Hessian of the energy function at u with the vector v (shape: [n_dofs])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">jvp</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="n">energy_fn</span><span class="p">),</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">delta</span><span class="p">),</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">delta</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>


<span class="n">delta_f</span> <span class="o">=</span> <span class="n">jacobian_vector_product</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_dofs</span><span class="p">),</span> <span class="n">v</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_dofs</span><span class="p">),</span> <span class="n">delta</span><span class="o">=</span><span class="n">delta_current</span><span class="p">)</span>

<span class="c1"># or can be passed directly to iterative solvers like jax.scipy.sparse.linalg.cg</span>
</code></pre></div>
<p>Some of the examples that use <strong>Matrix-Free Operators</strong> are</p>
<ul>
<li><a href="../examples/linear_elasticity/">Linear elasticity</a></li>
<li><a href="../examples/contact_3d/">Contact between deformable bodies</a></li>
<li><a href="../examples/fracture_quasistatic_3d/">Fracture using Cohesive Traction Law</a></li>
<li><a href="../examples/thermal_shock_fracture/">Multiphysical Fracture using Phasefield</a></li>
</ul>
<h2 id="sparse-differentiation">Sparse Differentiation<a class="headerlink" href="#sparse-differentiation" title="Permanent link">¤</a></h2>
<p><a href="../api/tatva.sparse/#sparse"><code>tatva.sparse</code></a> provides a sparse differentiation engine that reduces the cost from <span class="arithmatex">\(O(N)\)</span> to <span class="arithmatex">\(O(c)\)</span>, where <span class="arithmatex">\(c\)</span> is the "chromatic number" of the mesh (typically small and constant, e.g., ~10-20 for 2D meshes).</p>
<p>The process has three steps:</p>
<ul>
<li><strong>Sparsity Pattern:</strong> Identify the non-zero structure.</li>
<li><strong>Coloring:</strong> Group non-interacting DOFs.</li>
<li><strong>Differentiation:</strong> Compute the matrix in batches.</li>
</ul>
<h3 id="sparsity-pattern">Sparsity Pattern<a class="headerlink" href="#sparsity-pattern" title="Permanent link">¤</a></h3>
<p>First, we analyze the mesh connectivity to determine which DOFs interact. <a href="../api/tatva.sparse/#tatva.sparse.create_sparsity_pattern"><code>create_sparsity_pattern</code></a> returns the indices of the non-zero entries.</p>
<div class="language-python highlight"><pre><span></span><code><span class="c1"># Extract sparsity topology from the mesh</span>
<span class="n">sparsity_pattern</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">create_sparsity_pattern</span><span class="p">(</span>
    <span class="n">mesh</span><span class="p">,</span>
    <span class="n">n_dofs_per_node</span><span class="o">=</span><span class="n">n_dofs_per_node</span>
<span class="p">)</span>

<span class="c1"># Convert to Scipy CSR format for efficient indexing and later use</span>
<span class="n">sparsity_pattern_csr</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span>
    <span class="p">(</span>
        <span class="n">sparsity_pattern</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="p">(</span><span class="n">sparsity_pattern</span><span class="o">.</span><span class="n">indices</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">sparsity_pattern</span><span class="o">.</span><span class="n">indices</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sparsity: </span><span class="si">{</span><span class="n">sparsity_pattern_csr</span><span class="o">.</span><span class="n">nnz</span><span class="si">}</span><span class="s2"> non-zeros&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="language-text highlight"><pre><span></span><code>Sparsity: 56 non-zeros
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Sparsity Pattern</p>
<p>In <code>tatva</code> we provide a few functionalities to generate sparsity patetrn for some specific problem. </p>
<ul>
<li>for a single physical field problem, <a href="../api/tatva.sparse/#tatva.sparse.create_sparsity_pattern"><code>sparse.create_sparsity_pattern</code></a></li>
<li>for KKT problems, <a href="../api/tatva.sparse/#tatva.sparse.create_sparsity_pattern_KKT"><code>sparse.create_sparsity_pattern_KKT</code></a></li>
<li>for reduced system via condensation  <a href="../api/tatva.sparse/#tatva.sparse.reduce_sparsity_pattern"><code>sparse.reduce_sparsity_pattern</code></a></li>
<li>for periodic problem <a href="../api/tatva.sparse/#tatva.sparse.create_sparsity_pattern_master_slave"><code>sparse.create_sparsity_pattern_master_slave</code></a></li>
</ul>
</div>
<h3 id="graph-coloring">Graph Coloring<a class="headerlink" href="#graph-coloring" title="Permanent link">¤</a></h3>
<p>We partition the degrees of freedom into independent sets (colors). Two DOFs share the same color <strong>only if</strong> they do not share an edge in the sparsity graph (Distance-1) and do not share a common neighbor (Distance-2). This ensures that when we perturb all DOFs of "Color A" simultaneously, their contributions to the Hessian do not overlap.</p>
<div class="admonition info">
<p class="admonition-title">Coloring Algorithm</p>
<p>We use <code>tatva_coloring</code> library to generate colors from a sparsity pattern and take the first return value which is the colors. The implemented coloring algorithm is a naive greedy-algorithm. One can easily use other coloring libraries such as <a href="https://github.com/gdalle/pysparsematrixcolorings">pysparsematrixcolorings</a> to use advanced coloring algorithms which are efficient as they generate less number of colors.</p>
</div>
<div class="language-python highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">tatva_coloring</span><span class="w"> </span><span class="kn">import</span> <span class="n">distance2_color_and_seeds</span>

<span class="n">colors</span> <span class="o">=</span> <span class="n">distance2_color_and_seeds</span><span class="p">(</span>
    <span class="n">row_ptr</span><span class="o">=</span><span class="n">sparsity_pattern_csr</span><span class="o">.</span><span class="n">indptr</span><span class="p">,</span>
    <span class="n">col_idx</span><span class="o">=</span><span class="n">sparsity_pattern_csr</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span>
    <span class="n">n_dofs</span><span class="o">=</span><span class="n">n_dofs</span><span class="p">,</span>
<span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of colors required: </span><span class="si">{</span><span class="n">jnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="language-text highlight"><pre><span></span><code>Number of colors required: 8
</code></pre></div>
<h3 id="sparse-differentiation_1">Sparse Differentiation<a class="headerlink" href="#sparse-differentiation_1" title="Permanent link">¤</a></h3>
<p>Finally, we use <a href="../api/tatva.sparse/#tatva.sparse.jacfwd"><code>sparse.jacfwd</code></a>. This function automatically:
-  Perturbs the input <span class="arithmatex">\(\boldsymbol{u}\)</span> using the color groups.
-  Evaluates the gradient efficiently (Batched JVPs).
-  Reconstructs the values into the correct sparse matrix locations.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>We use our own implementation of sparse differentiation to make it scalable for large problems. But one can use libraries such as <a href="https://github.com/mfschubert/sparsejac">sparsejac</a> which has been an source of inspiration for our own implementation.</p>
</div>
<div class="language-python highlight"><pre><span></span><code><span class="n">gradient_fn</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jacrev</span><span class="p">(</span><span class="n">energy_fn</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Gradient with respect to u</span>

<span class="c1"># differentiate the residual using the sparsity information</span>
<span class="n">K_sparse_fn</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">jacfwd</span><span class="p">(</span>
    <span class="n">gradient</span><span class="o">=</span><span class="n">gradient_fn</span><span class="p">,</span>
    <span class="n">row_ptr</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sparsity_pattern_csr</span><span class="o">.</span><span class="n">indptr</span><span class="p">),</span>
    <span class="n">col_indices</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sparsity_pattern_csr</span><span class="o">.</span><span class="n">indices</span><span class="p">),</span>
    <span class="n">colors</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">colors</span><span class="p">),</span>
    <span class="n">color_batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="c1"># Batch size for evaluating the element routine</span>
<span class="p">)</span>

<span class="n">u_current</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_dofs</span><span class="p">)</span>  <span class="c1"># Example input</span>
<span class="n">K_sparse</span> <span class="o">=</span> <span class="n">K_sparse_fn</span><span class="p">(</span><span class="n">u_current</span><span class="p">,</span> <span class="n">delta_current</span><span class="p">)</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>The above function <code>K_sparse_fn</code> needs to be created only once given the sparsity pattern is not changing. Once created one can use te generated function within the simulation loop. 
If the energy function takes additional arguments for example history parameters then the generated <code>K_sparse_fn</code> also takes the same arguments. </p>
</div>
<h3 id="computing-k-at-fixed-additional-parameters">Computing <strong>K</strong> at fixed additional parameters<a class="headerlink" href="#computing-k-at-fixed-additional-parameters" title="Permanent link">¤</a></h3>
<p>Sometimes we need to evalues <span class="arithmatex">\(\mathbf{K}\)</span> at fixed values for additinal arguments but updated values of <span class="arithmatex">\(\boldsymbol{u}\)</span>. For example, in Newton-Raphson or Staggered solvers. Use <code>partial</code> from <code>functools</code> to freeze some argument values. For example</p>
<div class="language-python highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>

<span class="n">K_sparse_partial</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">K_sparse_fn</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">delta_current</span><span class="p">))</span>

<span class="c1"># newton iteration</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">iter</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="c1"># call K_sparse_partial with just u</span>
    <span class="n">K_sparse</span> <span class="o">=</span> <span class="n">K_sparse_partial</span><span class="p">(</span><span class="n">u_new</span><span class="p">)</span>
    <span class="o">...</span>
</code></pre></div>
<p>Some of the examples that use <strong>sparse differentiation</strong> are:</p>
<ul>
<li><a href="../examples/homogenization_periodic/">Periodic Boundary Conditions using Lagrange Multiplier</a></li>
<li><a href="../examples/ncm_metamaterial/">Neural Constitutive Law</a></li>
<li><a href="../examples/neural_operator_method_3d/">Neural Operator Element method</a></li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>For extremely large problems, even storing the sparse matrix indices might be too memory-intensive. Then one should use <strong>Matrix-free</strong> approach.
Also, for the problems where finding the sparsity pattern is difficult.</p>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2026 ETH Zurich (SMEC)
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.sections", "header-autohide", "announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.tooltips", "navigation.instant.preview", "navigation.path", "navigation.sections", "navigation.tabs.sticky", "search.highlight", "search.suggest", "content.footnote.tooltips"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://unpkg.com/vtk.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
      
        <script src="../javascripts/carousel.js"></script>
      
    
  </body>
</html>